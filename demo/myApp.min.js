var __extends=this.__extends||function(t,i){function n(){this.constructor=t}for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s]);n.prototype=i.prototype,t.prototype=new n},SimpleGame=function(){function t(){this.game=new Phaser.Game(800,600,Phaser.AUTO,"content",{preload:this.preload,create:this.create})}return t.prototype.preload=function(){this.game.load.image("arrow","assets/img/arrow.png"),this.game.load.image("ship","assets/img/ship_red.png"),this.game.load.image("goBtn","assets/img/go.png")},t.prototype.create=function(){this.game.state.add("Main",MainScene,!1),this.game.state.start("Main")},t}(),MainScene=function(t){function i(){t.apply(this,arguments),this.DEMO_MODE=!0}return __extends(i,t),i.prototype.create=function(){this.shipObjects=[],this.game.stage.backgroundColor=13882323,this.shipObjects.push(new ShipObject(this.game,100,100,new Point(1,0))),this.DEMO_MODE&&(this.shipObjects.push(new ShipObject(this.game,100,300,new Point(1,0))),this.shipObjects.push(new ShipObject(this.game,100,500,new Point(1,0))),this.shipObjects.push(new ShipObject(this.game,500,200,new Point(-1,0))),this.shipObjects.push(new ShipObject(this.game,500,400,new Point(-1,0)))),this.button=this.game.add.button(0,0,"goBtn"),this.button.scale.x=.5,this.button.scale.y=.5,this.button.onInputDown.add(this.btnClick,this)},i.prototype.btnClick=function(){if(console.log("Go clicked"),!this.isSimulating){this.isSimulating=!0,this.simulationStep=0;for(var t=0;t<this.shipObjects.length;t++)this.shipObjects[t].startSimulation()}},i.prototype.update=function(){if(this.isSimulating&&this.simulationStep<Constants.TURNSTEPS){for(var t=0;t<this.shipObjects.length;t++)this.shipObjects[t].stepSimulation(this.simulationStep);this.simulationStep++}else if(this.isSimulating&&this.simulationStep>=Constants.TURNSTEPS){for(var t=0;t<this.shipObjects.length;t++)this.shipObjects[t].endSimulation();this.isSimulating=!1}},i}(Phaser.State),Constants=function(){function t(){}return t.TURNSTEPS=100,t}();window.onload=function(){new SimpleGame};var Point=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.normalize=function(){var t=this.length();0!=t?(this.x=this.x/t,this.y=this.y/t):console.debug("Error: Cannot normalize a zero length vector")},t.prototype.toAngle=function(){return Math.atan2(this.y,this.x)},t}(),BezierCurve=function(){function t(){}return t}(),BezierPath=function(){function t(t){this.DEBUG=!0,this.graphics=t}return t.prototype.clear=function(){this.graphics.clear()},t.prototype.drawCurve=function(t){this.DEBUG&&(this.graphics.lineStyle(2,32768),this.graphics.moveTo(t.start.x,t.start.y),this.graphics.lineTo(t.control.x,t.control.y),this.graphics.lineTo(t.end.x,t.end.y)),this.graphics.lineStyle(3,16777215),this.graphics.moveTo(t.start.x,t.start.y),this.graphics.quadraticCurveTo(t.control.x,t.control.y,t.end.x,t.end.y)},t}(),TempMath=function(){function t(){}return t.findAnAngle=function(t,i){var n=Math.atan2(i.y-t.y,i.x-t.x);return n},t.solve=function(t,i){var n=new Point(i.x-t.location.x,i.y-t.location.y),s=this.findAnAngle(t.facing,n),e=t.facing.toAngle(),o=s-e;console.log("DestinationAngle="+s+" HeadingAngle="+e+"RelativeAngle="+o);var h=n.length()/2;console.log("Adjacent="+h);var a=h/Math.cos(o);console.log("Hypotenuse="+a);var r=new Point;return r.x=t.facing.x*a+t.location.x,r.y=t.facing.y*a+t.location.y,console.log("Control Point="+r),r},t.distance=function(t,i){var n=i.x-t.x,s=i.y-t.y;return Math.sqrt(n*n+s*s)},t.quadraticBezier=function(t,i,n,s){function e(t,i,n){var s=i-t;return t+s*n}var o=e(t.x,i.x,s),h=e(t.y,i.y,s),a=e(i.x,n.x,s),r=e(i.y,n.y,s),p=e(o,a,s),c=e(h,r,s);return console.debug("Quadratic Bezier. x="+p+" y="+c+" %="+s),new Point(p,c)},t}(),ShipObject=function(t){function i(i,n,s,e){t.call(this,i),this.game=i,this.ship=new Ship,this.ship.oldLocation=new Point(n,s),this.ship.location=new Point(n,s),this.ship.facing=e;var o=new Phaser.Graphics(i,0,0);this.add(o),this.pathMgr=new BezierPath(o),this.shipSprite=new Phaser.Sprite(i,n,s,"ship"),this.add(this.shipSprite),this.shipSprite.scale.x=.5,this.shipSprite.scale.y=.5,this.shipSprite.anchor.x=.5,this.shipSprite.anchor.y=.5,this.shipSprite.rotation=this.ship.facing.toAngle(),this.arrowSprite=new Phaser.Sprite(i,0,0,"arrow"),this.add(this.arrowSprite),this.arrowSprite.anchor.x=.5,this.arrowSprite.anchor.y=.5,this.arrowSprite.inputEnabled=!0,this.arrowSprite.input.draggable=!0,this.setDefaultPath()}return __extends(i,t),i.prototype.setDefaultPath=function(){console.log("Setting default path");var t=new Point(this.ship.facing.x*this.ship.speed+this.ship.location.x,this.ship.facing.y*this.ship.speed+this.ship.location.y);this.updatePath(t)},i.prototype.updatePath=function(t){var i=this.calculatePath(t);this.arrowSprite.x=t.x,this.arrowSprite.y=t.y,this.arrowSprite.rotation=TempMath.findAnAngle(i.control,i.end),this.pathMgr.drawCurve(i),this.ship.path=i},i.prototype.calculatePath=function(t){var i=TempMath.solve(this.ship,t),n=new BezierCurve;return n.start=new Point(this.ship.location.x,this.ship.location.y),n.control=i,n.end=t,n},i.prototype.update=function(){if(this.arrowSprite.input.isDragged){this.pathMgr.clear();var t=new Point(this.arrowSprite.x,this.arrowSprite.y);this.updatePath(t)}},i.prototype.startSimulation=function(){this.pathMgr.clear(),this.arrowSprite.visible=!1},i.prototype.stepSimulation=function(t){var i=this.ship.path,n=TempMath.quadraticBezier(i.start,i.control,i.end,t/Constants.TURNSTEPS);this.ship.oldLocation.x=this.ship.location.x,this.ship.oldLocation.y=this.ship.location.y,this.ship.location.x=n.x,this.ship.location.y=n.y,this.ship.facing.x=this.ship.location.x-this.ship.oldLocation.x,this.ship.facing.y=this.ship.location.y-this.ship.oldLocation.y,this.ship.facing.normalize(),console.log("new facing x="+this.ship.facing.x+" y="+this.ship.facing.y);var s=TempMath.distance(this.ship.oldLocation,this.ship.location),e=TempMath.findAnAngle(this.ship.oldLocation,this.ship.location);console.log("Distance = "+s+" Angle="+e),this.shipSprite.position.x=this.ship.location.x,this.shipSprite.position.y=this.ship.location.y,this.shipSprite.rotation=e},i.prototype.endSimulation=function(){this.setDefaultPath(),this.arrowSprite.visible=!0},i}(Phaser.Group),Ship=function(){function t(){this.speed=100}return t}();